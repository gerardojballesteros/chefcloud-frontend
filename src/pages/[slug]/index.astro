---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import Header from "../../components/header/Header.astro";
import { getMenuBySlug } from "../../services/menu.service";
import type { MenuResponse } from "../../types/menu";

const { slug } = Astro.params;

let data: MenuResponse | null = null;
let theme: string = "dark";

try {
  data = await getMenuBySlug(slug as string);
  if (data?.theme && typeof data.theme === "string") {
    theme = data.theme;
  }
} catch (err) {
  console.error("Error cargando datos del menú:", err);
}
---

{
  !data ? (
    <div class="text-center py-10 text-red-600 font-bold">
      Restaurante no encontrado o error de conexión.
    </div>
  ) : data.redirectToAll ? (
    // ✅ Solo tiene 1 menú → mostrar todo
    <Layout theme={theme} title={`${data.name} | Chefcloud`}>
      <Header name={data.name} logo={data.logo} theme={theme} />

      <main class="max-w-5xl mx-auto p-4">
        {data.menus?.map((menu) => (
          <section class="mb-8">
            <h2 class="text-xl font-semibold mb-2">{menu.name}</h2>
            {menu.categories.map((category) => (
              <div class="mb-4">
                <h3 class="text-lg font-medium text-skin-primary mb-1">
                  {category.name}
                </h3>
                <ul class="space-y-2">
                  {category.items.map((item) => (
                    <li class="border-b pb-2">
                      <div class="flex justify-between">
                        <span>{item.name}</span>
                        <span>${item.price}</span>
                      </div>
                      <p class="text-sm text-gray-500">{item.description}</p>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </section>
        ))}
      </main>
    </Layout>
  ) : (
    // ✅ Tiene múltiples menús → mostrar sucursales
    <Layout theme={theme} title={`${data.name} | Chefcloud`}>
      <Header name={data.name} theme={theme} />

      <main class="max-w-3xl mx-auto p-6 text-center">
        <h2 class="text-2xl font-semibold mb-6">Selecciona una sucursal</h2>
        <ul class="space-y-4">
          {data.branches?.map((branch) => (
            <li>
              <a
                href={`/${data.slug}/${branch.slug}`}
                class="inline-block px-4 py-2 bg-skin-primary text-white rounded hover:opacity-80 transition"
              >
                {branch.name}
              </a>
            </li>
          ))}
        </ul>
      </main>
    </Layout>
  )
}
